import cv2
import time
import pygame

# === AUDIO SETUP ===
pygame.mixer.init()

SOUND_MAP = {
    1: pygame.mixer.Sound("eggplant.wav"),
    2: pygame.mixer.Sound("redpepper.wav"),
    3: pygame.mixer.Sound("pumpkin.wav"),
    4: pygame.mixer.Sound("onion.wav"),
    5: pygame.mixer.Sound("broccoli.wav"),
    6: pygame.mixer.Sound("carrot.wav"),
    7: pygame.mixer.Sound("tomato.wav"),
    8: pygame.mixer.Sound("carrot.wav"),
}

# === COOLDOWN PER ID ===
COOLDOWN = 3.0  # seconds per ID
last_played = {id_: 0 for id_ in SOUND_MAP.keys()}

# === CAMERA SETUP === 
cap = cv2.VideoCapture(1)
aruco_dict  = cv2.aruco.getPredefinedDictionary(cv2.aruco.DICT_4X4_50)
aruco_params = cv2.aruco.DetectorParameters()

TARGET_IDS = set(SOUND_MAP.keys())

while True:
    ret, frame = cap.read()
    if not ret:
        break

    corners, ids, rejected = cv2.aruco.detectMarkers(frame, aruco_dict, parameters=aruco_params)

    if ids is not None:
        detected_ids = set(int(i) for i in ids.flatten())

        # Check each detected ID separately
        for marker_id in detected_ids:
            if marker_id in TARGET_IDS:
                now = time.time()

                # ID-specific cooldown check
                if now - last_played[marker_id] > COOLDOWN:
                    SOUND_MAP[marker_id].play()
                    last_played[marker_id] = now

        cv2.aruco.drawDetectedMarkers(frame, corners, ids)

    cv2.imshow("ArUco detection", frame)
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
