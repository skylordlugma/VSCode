import cv2
import socket
import struct
import time
import pygame

# === AUDIO SETUP ===
pygame.mixer.init()

SOUND_MAP = {
    1: pygame.mixer.Sound("eggplant.wav"),
    2: pygame.mixer.Sound("redpepper.wav"),
    3: pygame.mixer.Sound("pumpkin.wav"),
    4: pygame.mixer.Sound("onion.wav"),
    5: pygame.mixer.Sound("broccoli.wav"),
    6: pygame.mixer.Sound("garlic.wav"),
    7: pygame.mixer.Sound("tomato.wav"),
    8: pygame.mixer.Sound("carrot.wav"),
}

# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
# CHOOSE WHICH IDS ARE ACTIVE HERE
# Only these IDs will:
#   - trigger the 3s laser pulse + cooldown
#   - play their sounds (with per-ID cooldown)
ACTIVE_IDS = [3, 5, 6]   # <---- EDIT THIS LIST
# <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

# === AUDIO COOLDOWN PER ACTIVE ID ===
AUDIO_COOLDOWN = 3.0  # seconds between sound plays
last_played = {id_: 0 for id_ in SOUND_MAP.keys()}

# === UDP SETUP (LASER FLAG TO SIMULINK) ===
UDP_IP   = "138.38.229.25"
UDP_PORT = 6767
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

# === UDP SETUP (RECEIVE HOMING BYTE FROM SIMULINK) ===
HOME_PORT = 6789
home_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
home_sock.bind(("0.0.0.0", HOME_PORT))
home_sock.setblocking(True)

print("â³ Waiting for homing signal (expecting raw byte = 1)...")

# ---------------------------------------------------------------------
#                          HOMING WAIT LOOP
# ---------------------------------------------------------------------
homed = False
while not homed:
    data, _ = home_sock.recvfrom(1024)
    if data == b'\x01':   # Simulink sends uint8(1) once when GPIO hits end switch
        homed = True
        print("ðŸ Homing complete â€” starting camera & scanning...")

# ---------------------------------------------------------------------
#                          CAMERA ACTIVATES NOW
# ---------------------------------------------------------------------

cap = cv2.VideoCapture(1)

# === ARUCO SETUP ===
aruco = cv2.aruco
dictionary = aruco.getPredefinedDictionary(aruco.DICT_4X4_50)
parameters = aruco.DetectorParameters()

# === LASER TRIGGER SETTINGS ===
PULSE_DURATION = 2.0   # seconds ON
COOLDOWN_TIME  = 3.0   # seconds where it can't retrigger

trigger_active  = False
cooldown_active = False
trigger_start   = 0.0
cooldown_start  = 0.0
last_id_found   = False

# ---------------------------------------------------------------------
#                            MAIN LOOP
# ---------------------------------------------------------------------
while True:
    ret, frame = cap.read()
    if not ret:
        break

    # --- CROP TO NARROW VERTICAL STRIP ---
    h, w = frame.shape[:2]
    narrow_ratio = 0.1
    new_w = int(w * narrow_ratio)
    x1 = (w - new_w) // 2
    x2 = x1 + new_w
    frame = frame[:, x1:x2]

    # --- DETECTION ---
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    corners, ids, rejected = aruco.detectMarkers(gray, dictionary, parameters=parameters)

    detected_ids = set()
    if ids is not None:
        detected_ids = {int(i) for i in ids.flatten()}

    # Check if ANY active ID is present
    active_id_found = any(mid in ACTIVE_IDS for mid in detected_ids)

    now = time.time()

    # -----------------------------------------------------------------
    #                     LASER STATE MACHINE
    # -----------------------------------------------------------------
    if active_id_found and not last_id_found and not trigger_active and not cooldown_active:
        trigger_active = True
        trigger_start = now
        print("ðŸ”µ Laser trigger STARTED")

    if trigger_active:
        if now - trigger_start > PULSE_DURATION:
            trigger_active = False
            cooldown_active = True
            cooldown_start = now
            print("ðŸ”´ Laser trigger ENDED â†’ cooldown started")

    if cooldown_active:
        if now - cooldown_start > COOLDOWN_TIME:
            cooldown_active = False
            print("âœ… Laser cooldown finished â€” ready again")

    # Send 1 during pulse, 0 otherwise
    laser_flag = 1 if trigger_active else 0
    sock.sendto(struct.pack('B', laser_flag), (UDP_IP, UDP_PORT))

    # -----------------------------------------------------------------
    #                          AUDIO LOGIC
    # -----------------------------------------------------------------
    for mid in detected_ids:
        if mid in SOUND_MAP and mid in ACTIVE_IDS:
            if now - last_played[mid] >= AUDIO_COOLDOWN:
                SOUND_MAP[mid].play()
                last_played[mid] = now
                print(f"ðŸ”Š Played sound for ID {mid}")

    # -----------------------------------------------------------------
    #                          DISPLAY
    # -----------------------------------------------------------------
    if ids is not None:
        aruco.drawDetectedMarkers(frame, corners, ids)

    cv2.imshow("ArUco", frame)
    last_id_found = active_id_found

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

# ---------------------------------------------------------------------
#                            CLEAN EXIT
# ---------------------------------------------------------------------
cap.release()
cv2.destroyAllWindows()
sock.close()
home_sock.close()
pygame.mixer.quit()

print("ðŸ‘‹ Program closed cleanly.")
