import cv2, numpy as np
import cv2.aruco as aruco
from collections import deque, Counter

M, N = 8, 3
history = deque(maxlen=M)

aruco_dict = aruco.getPredefinedDictionary(aruco.DICT_4X4_50)
params = aruco.DetectorParameters()
params.adaptiveThreshWinSizeMin = 5
params.adaptiveThreshWinSizeMax = 55
params.adaptiveThreshWinSizeStep = 10
params.minMarkerPerimeterRate = 0.02
params.maxMarkerPerimeterRate = 4.0
params.cornerRefinementMethod = aruco.CORNER_REFINE_SUBPIX
params.cornerRefinementWinSize = 5
params.cornerRefinementMaxIterations = 30
params.cornerRefinementMinAccuracy = 0.1

cap = cv2.VideoCapture(1)

while True:
    ok, frame = cap.read()
    if not ok:
        continue

    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    gray = cv2.GaussianBlur(gray, (5,5), 0)
    clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8,8))
    gray = clahe.apply(gray)

    corners, ids, rejected = aruco.detectMarkers(gray, aruco_dict, parameters=params)

    detected_ids = []
    if ids is not None:
        detected_ids = [int(x) for x in ids.flatten()]
    history.append(detected_ids)

    # Vote
    flat = [i for frame_ids in history for i in frame_ids]
    counts = Counter(flat)
    stable = [i for i,c in counts.items() if c >= N]

    # Debug view
    vis = frame.copy()
    if ids is not None:
        aruco.drawDetectedMarkers(vis, corners, ids)
    aruco.drawDetectedMarkers(vis, rejected, borderColor=(0,0,255))

    for sid in stable:
        cv2.putText(vis, f"STABLE: {sid}", (20, 40+30*stable.index(sid)),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0,255,0), 2)

    cv2.imshow("aruco debug", vis)

    key = cv2.waitKey(1) & 0xFF
    if key == ord('q'):
        break


cap.release()
cv2.destroyAllWindows()
