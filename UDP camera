import cv2
import socket
import struct

# --- UDP setup ---
UDP_IP   = "138.38.229.25"    # machine running Simulink / RPi IP
UDP_PORT = 6767             # must match Simulink local port

sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

# --- ArUco setup ---
aruco = cv2.aruco
dictionary = aruco.getPredefinedDictionary(aruco.DICT_4X4_50)
parameters = aruco.DetectorParameters()

cap = cv2.VideoCapture(1)

TARGET_ID = 7  # example ID that should trigger the laser

while True:
    ret, frame = cap.read()
    if not ret:
        break

    corners, ids, rejected = aruco.detectMarkers(frame, dictionary, parameters=parameters)

    laser_flag = 0

    if ids is not None:
        if TARGET_ID in ids.flatten():
            laser_flag = 1  # “ID seen, turn laser ON”

    # pack as a single byte (uint8)
    msg = struct.pack('B', laser_flag)
    sock.sendto(msg, (UDP_IP, UDP_PORT))

    # show frame for debugging
    aruco.drawDetectedMarkers(frame, corners, ids)
    cv2.imshow("ArUco", frame)

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()

